<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Foto FMF</title>
  <style>
    :root{
      --bg:#0b1220; --text:#ffffff;
      --brand:#d88147; --brand-2:#b40056;
      --danger:#ef4444; --success:#22c55e;
      --radius:28px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;
      background:linear-gradient(225deg,var(--brand),var(--brand-2));
      color:var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      text-align:center;
      padding:20px;
    }
    .wrap{width:min(520px,92vw); display:flex; flex-direction:column; align-items:center;}
    .card{
      background:linear-gradient(225deg,var(--brand),var(--brand-2));
      border-radius:var(--radius);
      padding:20px;
      backdrop-filter:blur(6px);
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    .form-header{display:flex; justify-content:center; align-items:center; min-height:64px; margin-bottom:10px;}
    .form-header img{max-height:72px; width:auto; object-fit:contain}
    h1{margin:10px 0 20px; font-size:22px; text-align:center}
    .preview{
      position:relative;
      background:#0b1220;
      border-radius:18px;
      overflow:hidden;
      aspect-ratio: 9 / 16;
      max-height:78vh;
      margin-bottom:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 4px 12px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02);
      width:100%;
    }
    .preview video,.preview canvas,.preview img{
      display:none; width:100%; height:100%; object-fit:cover;
    }
    .preview video.show,.preview canvas.show,.preview img.show{display:block}
    .remove-btn{
      position:absolute; right:10px; top:10px; display:none;
      color:#fff; background:var(--danger);
      width:34px; height:34px; border:none; border-radius:999px; cursor:pointer; font-weight:700;
    }

    /* Contador */
    .countdown{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.45);
      backdrop-filter:blur(3px);
    }
    .countdown.show{display:flex}
    .countdown .num{
      font-size:96px; font-weight:800; color:#fff;
      text-shadow:0 6px 20px rgba(0,0,0,.6);
    }

    .controls{
      display:flex; gap:12px; justify-content:center; margin:12px 0 4px;
      flex-wrap:wrap;
    }
    .btn{
      appearance:none; border:1px solid rgba(255,255,255,.22); color:#fff;
      background:linear-gradient(180deg,rgba(17,24,39,.8),rgba(17,24,39,.55));
      border-radius:16px; cursor:pointer; display:flex; align-items:center; justify-content:center;
      transition:transform .06s ease, border-color .2s ease;
      width:96px; height:96px; box-shadow:0 10px 24px rgba(0,0,0,.25)
    }
    .btn:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.36)}
    .btn svg{width:30px; height:30px}

    .alert{
      margin-top:10px; padding:10px 12px;
      border-radius:12px; border:1px solid; text-align:center;
      display:none; width:100%;
    }
    .alert.ok{display:block; background:var(--success); border-color:var(--success)}
    .alert.err{display:block; background:rgba(239,68,68,.09); border-color:rgba(255,255,255,.25); color:#fecaca}

    /* Overlay */
    .overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55); backdrop-filter:blur(3px); z-index:9999}
    .overlay.show{display:flex}
    .panel{
      width:min(92vw,520px);
      background:linear-gradient(225deg,var(--brand),var(--brand-2));
      border:1px solid rgba(255,255,255,.12);
      border-radius:22px; padding:18px; text-align:center;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      display:flex; flex-direction:column; align-items:center;
    }
    .panel img{max-width:100%; border-radius:14px; margin:10px 0}
    .big-loader{width:38px;height:38px;border:4px solid #fff;border-bottom-color:transparent;border-radius:50%;display:inline-block;animation:rotation 1s linear infinite}
    @keyframes rotation{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .actions{display:flex; gap:12px; justify-content:center; margin-top:12px; flex-wrap:wrap}
    .btn.icon{width:56px;height:56px; border-radius:999px}
    .drive-link{margin-top:8px; color:#fff; text-decoration:underline; word-break:break-all}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="form-header"><img src="./img/LOGO_FMF.png" alt="FMF" /></div>
      <h1>Toma tu foto</h1>

      <div class="preview" id="previewBox">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
        <img id="imgPrev" alt="previsualizaciÃ³n" />
        <div class="countdown" id="countOverlay"><div class="num" id="countNum">3</div></div>
        <button type="button" class="remove-btn" id="btnRemove">Ã—</button>
      </div>

      <div class="controls">
        <button class="btn" id="btnCamera" title="Activar/Detener cÃ¡mara">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        </button>
        <button class="btn" id="btnShot" title="Tomar foto">
          <svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" stroke="currentColor" stroke-width="4" fill="none"/><circle cx="50" cy="50" r="30" fill="currentColor"/></svg>
        </button>
        <label class="btn" for="fileInput" title="Subir imagen">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        </label>
        <input id="fileInput" type="file" accept="image/*" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0" />
      </div>

      <div id="msg" class="alert"></div>
    </div>
  </div>

  <!-- Overlay -->
  <div id="overlay" class="overlay">
    <div id="panel-wait" class="panel">
      <h2>Generando tu fotoâ€¦</h2>
      <span class="big-loader"></span>
      <p>Esto puede tardar unos segundos.</p>
    </div>
    <div id="panel-result" class="panel" style="display:none;">
      <h2>Â¡Listo! ðŸŽ‰</h2>
      <img id="outFoto" alt="Foto generada" />
      <a id="driveLink" class="drive-link" href="#" target="_blank" style="display:none">Ver en Drive</a>
      <div class="actions">
        <button id="btnPrint" class="btn icon" title="Imprimir">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
        </button>
        <button id="btnFinish" class="btn icon" style="background:var(--success);border-color:transparent" title="Finalizar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
        </button>
      </div>
    </div>
  </div>

<script>
  /* Tu Apps Script (para subir a Drive/Sheets) */
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwCzUEVAR7wqbaK-LJVXTgxOvxTsnmJhAaVi2JMLEU1s0PdqKHraDTE_cdglUyCK1mFdQ/exec";
  /* Tu flujo n8n (genera la foto a partir de la captura) */
  const N8N_WEBHOOK = "http://localhost:5678/webhook/fmf-intake";

  const video=document.getElementById('video');
  const canvas=document.getElementById('canvas');
  const imgPrev=document.getElementById('imgPrev');
  const btnCamera=document.getElementById('btnCamera');
  const btnShot=document.getElementById('btnShot');
  const fileInput=document.getElementById('fileInput');
  const btnRemove=document.getElementById('btnRemove');
  const msg=document.getElementById('msg');
  const overlay=document.getElementById('overlay');
  const panelWait=document.getElementById('panel-wait');
  const panelResult=document.getElementById('panel-result');
  const outFoto=document.getElementById('outFoto');
  const driveLink=document.getElementById('driveLink');
  const btnPrint=document.getElementById('btnPrint');
  const btnFinish=document.getElementById('btnFinish');
  const countOverlay=document.getElementById('countOverlay');
  const countNum=document.getElementById('countNum');

  let stream=null, currentDataURL="", currentBlob=null;

  function setAlert(type,text){ msg.className="alert "+(type==='err'?'err':'ok'); msg.textContent=text; msg.style.display="block"; }
  function clearAlert(){ msg.className="alert"; msg.textContent=""; msg.style.display="none"; }

  async function startCamera(){
    try{
      stream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ideal:'user'} }, audio:false });
      video.srcObject=stream; await video.play();
      video.classList.add('show'); imgPrev.classList.remove('show'); canvas.classList.remove('show');
    }catch(err){ setAlert('err',"No se pudo acceder a la cÃ¡mara: "+err.message); }
  }
  function stopCamera(){ if(stream){stream.getTracks().forEach(t=>t.stop());} stream=null; video.pause(); video.srcObject=null; video.classList.remove('show'); }

  btnCamera.onclick=()=>{ stream?stopCamera():startCamera(); };

  btnShot.onclick=()=>{ 
    if(!stream){ setAlert('err',"Primero activa la cÃ¡mara."); return; } 
    // contador
    let c=3; countNum.textContent=c; countOverlay.classList.add('show');
    const id=setInterval(()=>{ c--; if(c<=0){ clearInterval(id); countOverlay.classList.remove('show'); captureFrame(); } else { countNum.textContent=c; } },1000);
  };

  function captureFrame(){
    const w=video.videoWidth, h=video.videoHeight;
    if(!w||!h){ setAlert('err',"No hay imagen de la cÃ¡mara."); return; }
    canvas.width=w; canvas.height=h; canvas.getContext('2d').drawImage(video,0,0,w,h);
    currentDataURL=canvas.toDataURL('image/jpeg',0.92);
    canvas.classList.add('show'); imgPrev.classList.remove('show'); btnRemove.style.display='flex';
    stopCamera(); fetch(currentDataURL).then(r=>r.blob()).then(b=>currentBlob=b);
    sendToN8N();
  }

  fileInput.onchange=(e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const url=URL.createObjectURL(f); imgPrev.src=url; imgPrev.classList.add('show');
    currentBlob=f;
    const fr=new FileReader(); fr.onload=()=>{ currentDataURL=fr.result; sendToN8N(); }; fr.readAsDataURL(f);
    stopCamera();
  };

  btnRemove.onclick=()=>{ imgPrev.removeAttribute('src'); imgPrev.classList.remove('show'); canvas.classList.remove('show'); btnRemove.style.display='none'; currentDataURL=""; currentBlob=null; };

  /* 1) Enviar la captura a n8n para generar la foto final
     2) Con la foto final (dataURL), subirla a tu GAS_URL para guardarla en Drive/Sheets */
  async function sendToN8N(){
    overlay.classList.add('show'); panelWait.style.display='block'; panelResult.style.display='none';
    driveLink.style.display='none'; driveLink.removeAttribute('href');

    try{
      // 1) n8n
      const fd=new FormData();
      if(currentBlob){
        const ext=(currentBlob.type?.split('/')[1])||'jpg';
        fd.append('image',currentBlob,`captura.${ext}`);
      } else {
        fd.append('image_base64',currentDataURL);
      }
      const res=await fetch(N8N_WEBHOOK,{method:'POST',body:fd});
      const json=await res.json();
      if(!json||!json.foto) throw new Error("Respuesta invÃ¡lida de n8n");

      outFoto.src=json.foto;

      // 2) Subir a GAS (Drive + Sheets)
      const saved = await uploadToGAS(json.foto); // <- dataURL
      if(saved?.driveLink){
        driveLink.href = saved.driveLink;
        driveLink.style.display = 'block';
      }

      panelWait.style.display='none'; panelResult.style.display='flex';
    }catch(err){
      setAlert('err',err.message || 'Error en el proceso');
      overlay.classList.remove('show');
    }
  }

  async function uploadToGAS(dataURL){
    try{
      const fd = new FormData();
      fd.append('image_base64', dataURL);
      const res = await fetch(GAS_URL, { method:'POST', body:fd, mode:'cors' });
      const j   = await res.json().catch(()=>null);
      if(!j || !j.ok) throw new Error(j?.error || 'Error al guardar en Drive');
      return j; // { ok, driveLink, imagePublicUrl, ... }
    }catch(e){
      // Si falla el guardado, seguimos mostrando la imagen al usuario
      console.warn('Fallo al subir a GAS:', e);
      return null;
    }
  }

  btnPrint.onclick=()=>{
    const iframe=document.createElement('iframe');
    iframe.style.position='fixed';iframe.style.width='0';iframe.style.height='0';iframe.style.border='0';
    document.body.appendChild(iframe);
    const doc=iframe.contentDocument||iframe.contentWindow.document;
    doc.open();
    doc.write(`<html><body style="margin:0;display:flex;align-items:center;justify-content:center;background:#fff">
      <img src="${outFoto.src}" style="max-width:100%;max-height:100vh" onload="window.print();"/>
    </body></html>`);
    doc.close();
    setTimeout(()=>document.body.removeChild(iframe),1000);
  };

  btnFinish.onclick=()=>{ overlay.classList.remove('show'); outFoto.src=""; clearAlert(); };
</script>
</body>
</html>
