<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro FMF</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#111827;
      --muted:#94a3b8;
      --text:#ffffff;
      --brand:#d88147;
      --brand-2:#b40056;
      --danger:#ef4444;
      --success:#22c55e;
      --surface:#0b1220;
      --outline:#1f2937;
      --radius:28px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;
      background:linear-gradient(225deg, var(--brand), var(--brand-2));
      color:var(--text);
      display:flex;justify-content:center;align-items:center;
      min-height:100vh;padding:20px
    }
    .wrap{max-width:480px;width:100%}
    .sr-only{position:absolute !important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    .form-header{display:flex;justify-content:center;align-items:center;min-height:74px;margin-top: clamp(10px, 6vh, 28px);padding-inline: 6px;}
    .form-header img{max-height:75px;width:auto;object-fit:contain;}

    .card{
      position:relative;background:linear-gradient(225deg, var(--brand), var(--brand-2));
      border-radius:var(--radius);padding:22px 22px 18px;border:none;backdrop-filter: blur(6px);overflow:hidden;
    }
    .card::before{display:none !important;}

    h1{
      font-size:28px;margin:0 0 16px;font-weight:700;letter-spacing:.2px;text-align:center;color:#fff;
      height: 50px;background-image: url("https://drive.google.com/uc?export=view&id=1VEYMSHkXT_skEzpzlPMwwGMnp87QArAe");
      background-size: contain;background-repeat: no-repeat;background-position: center;text-indent: -9999px;
    }

    .preview{
      position:relative;background:var(--surface);border:none;
      box-shadow: 0 4px 12px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02);
      border-radius:18px; overflow:hidden;height:280px; display:flex; align-items:center; justify-content:center; margin-bottom:14px
    }
    .preview video,.preview canvas,.preview img{max-width:100%; max-height:100%; object-fit:contain; display:none;}
    .preview video.show,.preview canvas.show{display:block;width:100%;height:100%;object-fit:cover}
    .preview img.show{display:block;width:auto;height:auto;max-width:100%;max-height:100%;object-fit:contain}

    .badge{position:absolute;left:16px;bottom:14px;font-size:12px;color:#fff;background:rgba(2,8,23,.6);border:1px solid rgba(255,255,255,.25);padding:6px 10px;border-radius:999px; display:none;}
    .badge.show{display:none}
    .remove-btn{position:absolute;right:12px;top:12px;display:none;color:white;background:var(--danger);width:32px;height:32px;border-radius:50%;border:none;cursor:pointer;font-size:16px;font-weight:bold;align-items:center;justify-content:center}
    .remove-btn.show{display:flex}

    .countdown{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(2px)}
    .countdown.show{display:flex}
    .countdown .num{font-size:96px;line-height:1;font-weight:800;color:#fff;text-shadow:0 8px 24px rgba(0,0,0,.45)}

    .controls{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:8px 0 6px}
    .btn{
      appearance:none;border:1px solid rgba(255,255,255,.22);color:#fff;
      background:linear-gradient(180deg,rgba(17,24,39,.8),rgba(17,24,39,.55));
      padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:600;letter-spacing:.2px;
      transition:transform .06s ease, background .2s ease, border-color .2s ease;display:flex;align-items:center;justify-content:center;font-size:0
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.36)}
    .btn:active{transform:translateY(0)}
    .btn.primary{background-color:var(--success);border-color:transparent;color:#fff;width:auto;font-size:1rem}
    .btn.primary:hover{background-color:#16a34a;}
    .btn.secondary{background:linear-gradient(180deg,#1f2937,#111827); width:60px; height:60px; padding:0; }
    .btn-icon{width:36px;height:36px}
    .btn-icon.camera{content:url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"%3E%3Cpath d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/%3E%3Ccircle cx="12" cy="13" r="4"/%3E%3C/svg%3E')}
    .btn-icon.shutter{content:url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle cx="50" cy="50" r="48" stroke="%23ffffff" stroke-width="4" fill="none"/%3E%3Ccircle cx="50" cy="50" r="30" fill="%23ffffff"/%3E%3C/svg%3E')}
    .btn-icon.upload{content:url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"%3E%3Cpath d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/%3E%3Cpolyline points="17 8 12 3 7 8"/%3E%3Cline x1="12" y1="3" x2="12" y2="15"/%3E%3C/svg%3E')}

    .field{display:flex;flex-direction:column;gap:8px}
    label{font-size:13px;color:#fff; display:none; }
    .input-like, input[type="text"], input[type="email"], #team{
      width: 100%;height: 48px;padding: 12px 14px;border-radius: 14px;border: 1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.30);color: #fff;text-align: center;outline: none;box-shadow: none;transition: border-color .2s ease, box-shadow .2s ease, background .2s ease, color .2s ease;appearance: none;
    }
    input::placeholder{ color: rgba(255,255,255,.85); text-align: center; }
    input[type="text"]:hover, input[type="email"]:hover,#team:hover{border-color: rgba(255,255,255,.32)}
    input[type="text"]:focus, input[type="email"]:focus, #team:focus{border-color:#fff; box-shadow:0 0 0 3px rgba(255,255,255,.18)}
    input[type="text"]:not(:placeholder-shown), input[type="email"]:not(:placeholder-shown){background: rgba(0,0,0,.30); color:#fff; border-color: rgba(255,255,255,.22)}
    .invalid{border-color: rgba(255,255,255,0.95) !important; box-shadow:0 0 0 3px rgba(255,255,255,0.28) !important;}

    #team{
      background-image: linear-gradient(45deg, transparent 50%, #bbb 50%),linear-gradient(135deg, #bbb 50%, transparent 50%);
      background-position: calc(100% - 22px) 50%, calc(100% - 16px) 50%;
      background-size: 6px 6px, 6px 6px; background-repeat:no-repeat;
    }
    #team option {background:#fff;color:#111}
    #team:valid {background: rgba(0,0,0,.30); color:#fff; border:1px solid rgba(255,255,255,.22)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:10px}
    .submit-row{display:flex;justify-content:center;margin-top:8px}
    .alert{margin-top:14px;padding:12px 14px;border-radius:12px;border:1px solid;display:none;text-align:center}
    .alert.ok{display:block;border-color:var(--success);background-color:var(--success);color:#fff}
    .alert.err{display:block;border-color:rgba(255,255,255,.25);background:rgba(239,68,68,.09);color:#fecaca}

    .loader {width:24px;height:24px;border:3px solid #fff;border-bottom-color:transparent;border-radius:50%;display:inline-block;box-sizing:border-box;animation:rotation 1s linear infinite}
    @keyframes rotation {0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

    /* Overlay de espera/resultado */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(3px);z-index:9999}
    .overlay.show{display:flex}

    /* PANEL CON DEGRADADO */
    .panel{
      width:min(92vw,480px);
      background: linear-gradient(225deg, var(--brand), var(--brand-2));
      border: none;
      border-radius: 20px;
      padding: 18px;
      text-align: center;
      color: #fff;
      box-shadow: 0 12px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
    }
    .panel h2{margin:6px 0 10px}
    .panel img{max-width:100%;border-radius:14px;margin:10px 0;background:#00000022}

    .big-loader{width:38px;height:38px;border:4px solid #fff;border-bottom-color:transparent;border-radius:50%;display:inline-block;animation:rotation 1s linear infinite}
    .actions{display:flex;gap:10px;justify-content:center;margin-top:10px}

    /* Botones visibles sobre el degradado */
    .panel .btn{
      border:1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.25);
      color:#fff;
      font-size:14px;
    }
    .panel .btn.primary{
      background: rgba(34,197,94,.95);
      border-color: transparent;
      color:#fff;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="form-header">
        <img src="./img/LOGO_FMF.png" alt="Registro FMF" />
      </div>
      <h1>Registro FMF</h1>

      <div class="preview" id="previewBox">
        <video id="video" playsinline></video>
        <canvas id="canvas"></canvas>
        <img id="imgPrev" alt="previsualizaci√≥n" />
        <div class="countdown" id="countOverlay"><div class="num" id="countNum">3</div></div>
        <span class="badge" id="badgeText"></span>
        <button type="button" class="remove-btn" id="btnRemove">X</button>
      </div>

      <div class="controls">
        <button class="btn secondary" id="btnCamera"><img class="btn-icon camera" /></button>
        <button class="btn secondary" id="btnShot"><img class="btn-icon shutter" /></button>
        <label class="btn secondary" for="fileInput" id="btnFileLbl"><img class="btn-icon upload" /></label>
        <input id="fileInput" type="file" accept="image/*" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0" />
      </div>

      <div class="grid">
        <div class="field"><input id="name" type="text" placeholder="Nombre y Apellido" autocomplete="name" /></div>
        <div class="field"><input id="email" type="email" placeholder="Correo Electr√≥nico" autocomplete="email" /></div>
        <div class="field"><input id="phone" type="text" inputmode="numeric" placeholder="Tel√©fono (10 D√≠gitos)" maxlength="10" /></div>
        <div class="field">
          <select id="team">
            <option value="">Equipo Favorito</option>
            <option value="Am√©rica">Am√©rica</option>
            <option value="Tigres">Tigres</option>
            <option value="Toluca">Toluca</option>
            <option value="Pachuca">Pachuca</option>
            <option value="Pumas">Pumas</option>
            <option value="Monterrey">Monterrey</option>
            <option value="Ju√°rez">Ju√°rez</option>
            <option value="Chivas">Chivas</option>
            <option value="Le√≥n">Le√≥n</option>
            <option value="Cruz Azul">Cruz Azul</option>
            <option value="San Luis">San Luis</option>
            <option value="Atlas">Atlas</option>
            <option value="Santos">Santos</option>
            <option value="Necaxa">Necaxa</option>
            <option value="Xolos">Xolos</option>
            <option value="Quer√©taro">Quer√©taro</option>
            <option value="Puebla">Puebla</option>
            <option value="Mazatl√°n">Mazatl√°n</option>
          </select>
        </div>
      </div>

      <div class="submit-row">
        <button class="btn primary" id="btnSend">Enviar</button>
      </div>

      <div id="msg" class="alert"></div>
    </div>
  </div>

  <!-- Overlay de espera/resultado -->
  <div id="overlay" class="overlay">
    <div id="panel-wait" class="panel">
      <h2>Generando tu foto‚Ä¶</h2>
      <span class="big-loader"></span>
      <p style="color:#f6f8fa;margin:10px 0 0;opacity:.9;">Esto puede tardar unos segundos.</p>
    </div>
    <div id="panel-result" class="panel" style="display:none;">
      <h2>¬°Listo! üéâ</h2>
      <img id="outFoto" alt="Foto generada" />
      <div class="actions">
        <button id="btnDownload" class="btn">Descargar</button>
        <button id="btnPrint" class="btn">Imprimir</button>
        <button id="btnFinish" class="btn primary">Finalizar</button>
      </div>
    </div>
  </div>

<script>
  /* === URLs de backend === */
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzok9RfWsAj8yU0pfrsszzUHrrRMlauyA84TH9A4DG_-fKdlTWTaZDgbVkZ4N9_Q3DO6g/exec";
  // Este debe ser tu webhook de n8n que RESPONDE con { foto: "data:image/jpeg;base64,..." }
  const N8N_WEBHOOK = 'http://localhost:5678/webhook/fmf-intake';

  /* ‚Äî‚Äî‚Äî Referencias UI ‚Äî‚Äî‚Äî */
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const imgPrev = document.getElementById('imgPrev');
  const btnCamera = document.getElementById('btnCamera');
  const btnShot = document.getElementById('btnShot');
  const btnFileLbl = document.getElementById('btnFileLbl');
  const fileInput = document.getElementById('fileInput');
  const badgeText = document.getElementById('badgeText');
  const btnRemove = document.getElementById('btnRemove');
  const msg = document.getElementById('msg');
  const countOverlay = document.getElementById('countOverlay');
  const countNum = document.getElementById('countNum');
  const nameEl = document.getElementById('name');
  const emailEl = document.getElementById('email');
  const phoneEl = document.getElementById('phone');
  const teamEl = document.getElementById('team');
  const btnSend = document.getElementById('btnSend');

  // Overlay
  const overlay = document.getElementById('overlay');
  const panelWait = document.getElementById('panel-wait');
  const panelResult = document.getElementById('panel-result');
  const outFoto = document.getElementById('outFoto');
  const btnFinish = document.getElementById('btnFinish');
  const btnDownload = document.getElementById('btnDownload');
  const btnPrint = document.getElementById('btnPrint');

  let stream = null;
  let currentDataURL = "";
  let currentBlob = null;
  let isSending = false;

  function setAlert(type, text){
    msg.className = "alert " + (type === 'err' ? 'err' : 'ok');
    msg.textContent = text;
  }
  function clearAlert(){ msg.className = "alert"; msg.textContent=""; }

  /* Validaci√≥n tel√©fono y correo */
  phoneEl.addEventListener('input', () => {
    const digits = phoneEl.value.replace(/\D+/g, '').slice(0,10);
    phoneEl.value = digits;
    phoneEl.classList.toggle('invalid', digits.length>0 && digits.length<10);
  });
  phoneEl.addEventListener('blur', () => {
    const ok = /^\d{10}$/.test(phoneEl.value);
    phoneEl.classList.toggle('invalid', !ok);
  });
  emailEl.addEventListener('blur', () => {
    const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailEl.value);
    emailEl.classList.toggle('invalid', !ok);
  });
  emailEl.addEventListener('input', () => { emailEl.classList.remove('invalid'); });

  async function startCamera(){
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode: 'user' }, audio:false });
      video.srcObject = stream;
      await video.play();
      video.classList.add('show');
      imgPrev.classList.remove('show');
      canvas.classList.remove('show');
      btnRemove.classList.remove('show');
      badgeText.classList.remove('show');
      clearAlert();
    }catch(err){ setAlert('err', "No se pudo acceder a la c√°mara: " + err.message); }
  }
  function stopCamera(){
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    video.pause(); video.removeAttribute('srcObject'); video.classList.remove('show');
  }
  btnCamera.addEventListener('click', async () => { stream ? stopCamera() : await startCamera(); });

  btnShot.addEventListener('click', async () => {
    if(!stream){ setAlert('err',"Primero activa la c√°mara."); return; }
    countOverlay.classList.add('show');
    let count = 3; countNum.textContent = count;
    const id = setInterval(()=>{
      count--;
      if(count<=0){ clearInterval(id); countOverlay.classList.remove('show'); captureFrame(); }
      else{ countNum.textContent = count; }
    }, 1000);
  });

  function captureFrame(){
    const w = video.videoWidth;
    const h = video.videoHeight;
    if(!w || !h){ setAlert('err',"No hay imagen de la c√°mara."); return; }
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);
    currentDataURL = canvas.toDataURL('image/jpeg', 0.92);
    canvas.classList.add('show');
    imgPrev.classList.remove('show');
    btnRemove.classList.add('show');
    badgeText.classList.add('show');
    stopCamera();
    fetch(currentDataURL).then(r=>r.blob()).then(b=>currentBlob=b);
  }

  fileInput.addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    try{
      const url = URL.createObjectURL(f);
      imgPrev.src = url;
      imgPrev.onload = ()=> URL.revokeObjectURL(url);
      imgPrev.classList.add('show');
      canvas.classList.remove('show');
      video.classList.remove('show');
      btnRemove.classList.add('show');
      badgeText.classList.add('show');
      clearAlert();
      const fr = new FileReader();
      fr.onload = () => { currentDataURL = fr.result; currentBlob = f; };
      fr.readAsDataURL(f);
      stopCamera();
    }catch(err){ setAlert('err',"No se pudo leer el archivo: "+err.message); }
  });

  btnRemove.addEventListener('click', ()=>{
    imgPrev.removeAttribute('src');
    imgPrev.classList.remove('show');
    canvas.classList.remove('show');
    btnRemove.classList.remove('show');
    badgeText.classList.remove('show');
    currentDataURL = "";
    currentBlob = null;
  });

  function validate(){
    let ok = true;
    const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailEl.value.trim());
    const phoneOk = /^\d{10}$/.test(phoneEl.value.trim());
    if(!nameEl.value.trim()){ nameEl.classList.add('invalid'); ok=false; } else { nameEl.classList.remove('invalid'); }
    if(!emailEl.value.trim() || !emailOk){ emailEl.classList.add('invalid'); ok=false; } else { emailEl.classList.remove('invalid'); }
    if(!phoneEl.value.trim() || !phoneOk){ phoneEl.classList.add('invalid'); ok=false; } else { phoneEl.classList.remove('invalid'); }
    if(!teamEl.value.trim()){ teamEl.classList.add('invalid'); ok=false; } else { teamEl.classList.remove('invalid'); }
    if(!currentDataURL){ ok=false; setAlert('err', "Por favor, toma una foto o sube una imagen."); }
    if(!ok){
      if(!currentDataURL) setAlert('err', "Por favor, toma una foto o sube una imagen.");
      else if(!nameEl.value.trim() || !emailEl.value.trim() || !phoneEl.value.trim()) setAlert('err', "Revisa los campos requeridos.");
      else if(!teamEl.value.trim()) setAlert('err', "Elige a tu Equipo Favorito");
    }
    return ok;
  }

  function showLoading(){
    btnSend.innerHTML = '<span class="loader"></span>';
    btnSend.disabled = true;
    isSending = true;
  }
  function restoreBtn(){
    btnSend.innerHTML = 'Enviar';
    btnSend.disabled = false;
    isSending = false;
  }

  // Overlay helpers
  function openOverlayWait(){ panelResult.style.display='none'; panelWait.style.display='block'; overlay.classList.add('show'); }
  function showOverlayResult(fotoDataURL){
    outFoto.src = fotoDataURL;
    panelWait.style.display='none';
    panelResult.style.display='block';
  }
  function closeOverlay(){ overlay.classList.remove('show'); }

  function dataURLtoBlob(dataURL) {
    const arr = dataURL.split(',');
    const mime = (arr[0].match(/:(.*?);/)||[])[1] || 'image/jpeg';
    const bstr = atob(arr[1] || '');
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while (n--) u8arr[n] = bstr.charCodeAt(n);
    return new Blob([u8arr], { type: mime });
  }

  // Enviar a n8n y ESPERAR la foto resultante
  async function sendToN8N() {
    const fd = new FormData();
    fd.append('name',  nameEl.value.trim());
    fd.append('email', emailEl.value.trim());
    fd.append('phone', phoneEl.value.trim());
    fd.append('team',  teamEl.value.trim());

    let fileBlob = currentBlob;
    if (!fileBlob && currentDataURL) fileBlob = dataURLtoBlob(currentDataURL);
    if (fileBlob) {
      const ext = (fileBlob.type && fileBlob.type.split('/')[1]) || 'jpg';
      fd.append('image', fileBlob, `captura.${ext}`);
    } else {
      fd.append('image_base64', currentDataURL || '');
    }

    const res = await fetch(N8N_WEBHOOK, { method: 'POST', body: fd });
    // Esperamos JSON: { foto: "data:image/jpeg;base64,..." }
    const json = await res.json().catch(() => null);
    if (!json || !json.foto) throw new Error('Respuesta inv√°lida de n8n');
    return json.foto;
  }

  /* ===== Env√≠o ===== */
  btnSend.addEventListener('click', async ()=>{
    clearAlert();
    if(isSending || !validate()) return;
    showLoading();

    try{
      // 1) Guarda en GAS
      const fd = new FormData();
      fd.append('name', nameEl.value.trim());
      fd.append('email', emailEl.value.trim());
      fd.append('phone', phoneEl.value.trim());
      fd.append('team', teamEl.value.trim());
      fd.append('image_base64', currentDataURL);

      const res = await fetch(GAS_URL, { method:'POST', body:fd, mode:'cors' });
      if(!res.ok){
        const t = await res.text().catch(()=> "");
        throw new Error("HTTP "+res.status+" "+t);
      }
      // 2) Pide a n8n la imagen resultante y mu√©strala
      openOverlayWait();
      const fotoResult = await sendToN8N();
      showOverlayResult(fotoResult);

      // Deja el bot√≥n Enviar normal para permitir otro env√≠o despu√©s de cerrar overlay
      restoreBtn();
    }catch(err){
      setAlert('err', "No se pudo completar el proceso: " + err.message);
      restoreBtn();
      closeOverlay();
    }
  });

  // Descargar
  btnDownload.addEventListener('click', ()=>{
    const a = document.createElement('a');
    a.href = outFoto.src;
    a.download = 'foto_fmf.jpg';
    document.body.appendChild(a);
    a.click();
    a.remove();
  });

  // Imprimir (cuadro nativo de Windows v√≠a iframe)
  function printOutFoto(){
    if(!outFoto.src) return;

    const iframe = document.createElement('iframe');
    iframe.style.position = 'fixed';
    iframe.style.right = '0';
    iframe.style.bottom = '0';
    iframe.style.width = '0';
    iframe.style.height = '0';
    iframe.style.border = '0';
    document.body.appendChild(iframe);

    const doc = iframe.contentWindow.document;
    doc.open();
    doc.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8" />
        <title>Imprimir foto</title>
        <style>
          @page { size: auto; margin: 10mm; }
          html, body { height: 100%; }
          body {
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
          }
          img { max-width: 100%; max-height: 100vh; }
        </style>
      </head>
      <body>
        <img src="${outFoto.src}" alt="Foto FMF" />
        <script>
          window.onload = function(){
            window.focus();
            window.print();
            setTimeout(function(){ window.close && window.close(); }, 300);
          };
        <\/script>
      </body>
      </html>
    `);
    doc.close();

    // Limpieza del iframe tras un rato
    setTimeout(() => {
      if (iframe && iframe.parentNode) iframe.parentNode.removeChild(iframe);
    }, 1500);
  }
  btnPrint?.addEventListener('click', printOutFoto);

  // Finalizar
  function resetForm(){
    nameEl.value = ""; emailEl.value = ""; phoneEl.value = ""; teamEl.value = "";
    nameEl.classList.remove('invalid'); emailEl.classList.remove('invalid');
    phoneEl.classList.remove('invalid'); teamEl.classList.remove('invalid');
    btnRemove.click(); clearAlert();
  }
  btnFinish.addEventListener('click', ()=>{
    resetForm();
    closeOverlay();
  });
</script>
</body>
</html>
